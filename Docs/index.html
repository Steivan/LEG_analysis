<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Document Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.12/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/babel.min.js"></script>
    <style>
        pre {
            background-color: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            font-size: 15px;
            line-height: 1.6;
            overflow-x: auto;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        code {
            font-family: 'Courier New', Courier, monospace;
            color: #333;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="root" class="min-h-screen"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Sample Markdown content (minimal placeholder)
        const sampleMarkdown = `
# Stochastic Generative Model for PV Production and Consumption

## Introduction
This is a placeholder. Upload the full Markdown file via the sidebar to view the complete model.
        `.trim();

        const MarkdownViewer = () => {
            const [markdownFiles, setMarkdownFiles] = useState([
                { name: 'Generative_Model_PV_Production_Consumption.md', content: sampleMarkdown }
            ]);
            const [selectedFile, setSelectedFile] = useState('Generative_Model_PV_Production_Consumption.md');
            const [markdownContent, setMarkdownContent] = useState(sampleMarkdown);
            const [error, setError] = useState(null);
            const [showRaw, setShowRaw] = useState(false);

            // Handle file upload
            const handleFileUpload = (event) => {
                try {
                    const file = event.target.files[0];
                    if (file && file.name.endsWith('.md')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const content = e.target.result;
                            setMarkdownFiles([...markdownFiles, { name: file.name, content }]);
                            setSelectedFile(file.name);
                            setMarkdownContent(content);
                        };
                        reader.readAsText(file);
                    } else {
                        setError('Please upload a valid .md file');
                    }
                } catch (e) {
                    setError(`Error uploading file: ${e.message}`);
                    console.error('File upload error:', e);
                }
            };

            // Render Markdown with LaTeX
            const renderMarkdown = (content) => {
                try {
                    // Preprocess non-standard LaTeX delimiters
                    let processedContent = content
                        .replace(/\\theta\s*\|/g, '\\theta \\mid')
                        .replace(/\[([^\]]*?\\[^[\]]*?)\]/g, '$$$1$$');

                    console.log('Processed Markdown:', processedContent);

                    // Parse Markdown
                    let html = marked.parse(processedContent, { breaks: true });

                    // Replace LaTeX delimiters with KaTeX rendering
                    html = html.replace(/\$\$([\s\S]*?)\$\$/g, (_, tex) => {
                        try {
                            console.log('Rendering display LaTeX:', tex);
                            return katex.renderToString(tex, { displayMode: true, throwOnError: false });
                        } catch (e) {
                            console.error('KaTeX display error:', e);
                            return tex;
                        }
                    });
                    html = html.replace(/\$([\s\S]*?)\$/g, (_, tex) => {
                        try {
                            console.log('Rendering inline LaTeX:', tex);
                            return katex.renderToString(tex, { displayMode: false, throwOnError: false });
                        } catch (e) {
                            console.error('KaTeX inline error:', e);
                            return tex;
                        }
                    });

                    return html;
                } catch (e) {
                    setError(`Error rendering Markdown: ${e.message}`);
                    console.error('Markdown rendering error:', e);
                    return '<p>Error rendering Markdown. Check console for details.</p>';
                }
            };

            // Update content when selected file changes
            useEffect(() => {
                try {
                    const file = markdownFiles.find(f => f.name === selectedFile);
                    setMarkdownContent(file ? file.content : '');
                    setError(null);
                } catch (e) {
                    setError(`Error selecting file: ${e.message}`);
                    console.error('File selection error:', e);
                }
            }, [selectedFile]);

            return (
                <div className="flex min-h-screen">
                    {/* Sidebar */}
                    <div className="w-1/4 bg-gray-800 text-white p-4">
                        <h2 className="text-xl font-bold mb-4">Markdown Files</h2>
                        {error && (
                            <div className="bg-red-500 text-white p-2 mb-4 rounded">
                                {error}
                            </div>
                        )}
                        <select
                            className="w-full p-2 mb-4 bg-gray-700 text-white rounded"
                            value={selectedFile}
                            onChange={(e) => setSelectedFile(e.target.value)}
                        >
                            {markdownFiles.map(file => (
                                <option key={file.name} value={file.name}>{file.name}</option>
                            ))}
                        </select>
                        <input
                            type="file"
                            accept=".md"
                            className="w-full p-2 bg-gray-700 text-white rounded"
                            onChange={handleFileUpload}
                        />
                        <button
                            className="w-full p-2 mt-4 bg-blue-500 text-white rounded hover:bg-blue-600"
                            onClick={() => setShowRaw(!showRaw)}
                        >
                            {showRaw ? 'Show Rendered' : 'Show Raw Markdown'}
                        </button>
                    </div>
                    {/* Main Content */}
                    <div className="w-3/4 p-6 bg-white">
                        {markdownContent ? (
                            showRaw ? (
                                <pre className="whitespace-pre-wrap font-mono text-sm bg-gray-100 p-4 rounded">
                                    {markdownContent}
                                </pre>
                            ) : (
                                <div
                                    className="prose max-w-none"
                                    dangerouslySetInnerHTML={{ __html: renderMarkdown(markdownContent) }}
                                />
                            )
                        ) : (
                            <p>Loading Markdown content...</p>
                        )}
                    </div>
                </div>
            );
        };

        try {
            ReactDOM.render(<MarkdownViewer />, document.getElementById('root'));
        } catch (e) {
            console.error('Error rendering React app:', e);
            document.getElementById('root').innerHTML = '<p style="color: red;">Error loading app. Check console for details.</p>';
        }
    </script>
</body>
</html>