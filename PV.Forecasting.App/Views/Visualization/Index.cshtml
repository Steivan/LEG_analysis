@model PV.Forecasting.App.Models.VisualizationViewModel
@{
    ViewData["Title"] = "Time Series Visualization";
}

<h2>@ViewData["Title"]</h2>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<form asp-controller="Visualization" asp-action="Index" method="get" id="visualizationForm">
    <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 15px;">
        <div>
            <span>Period:</span>
            <select asp-for="SelectedPeriod" asp-items="Model.PeriodOptions"></select>
        </div>
        <div>
            <span>Date:</span>
            <button type="button" id="prevPeriod" onclick="changeDate(-1)">&lt;</button>
            <input type="text" id="SelectedDate" name="SelectedDate" value="@Model.SelectedDate.ToString("yyyy-MM-dd")" />
            <button type="button" id="nextPeriod" onclick="changeDate(1)">&gt;</button>
        </div>
        <div>
            <span>Resolution:</span>
            <select asp-for="SelectedView" asp-items="Model.ViewOptions"></select>
        </div>
    </div>
    <div style="margin-bottom: 20px;">
        <span>Time Series:</span>
        @foreach (var option in Model.TimeSeriesOptions)
        {
            <input type="checkbox" name="SelectedTimeSeries" value="@option.Value" @(Model.SelectedTimeSeries.Contains(option.Value) ? "checked" : "") />
            <label>@option.Text</label>
        }
        <input type="submit" value="Update" style="margin-left: 20px;" />
    </div>
</form>

<div style="display: flex; flex-direction: column;">
    @if (Model.PlotHtmls.Any())
    {
        foreach (var plotHtml in Model.PlotHtmls.Values)
        {
            @Html.Raw(plotHtml)
        }
    }
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        flatpickr("#SelectedDate", {
            altInput: true,
            altFormat: "d.m.y",
            dateFormat: "Y-m-d",
            defaultDate: "@Model.SelectedDate.ToString("yyyy-MM-dd")",
            onChange: function(selectedDates, dateStr, instance) {
                // The actual input value is already updated by flatpickr
                document.getElementById('visualizationForm').submit();
            }
        });

        ['SelectedPeriod', 'SelectedView'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.addEventListener('change', () => {
                    document.getElementById('visualizationForm').submit();
                });
            }
        });

        document.querySelectorAll('input[name="SelectedTimeSeries"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                // We can choose to submit on change or wait for the "Update" button.
                // For now, let's keep the explicit update button for time series selection.
            });
        });
    });

    function changeDate(offset) {
        const dateInput = document.getElementById('SelectedDate');
        const period = document.getElementById('SelectedPeriod').value;
        let currentDate = new Date(dateInput.value);

        if (period === 'Day') {
            currentDate.setDate(currentDate.getDate() + offset);
        } else if (period === 'Week') {
            currentDate.setDate(currentDate.getDate() + (7 * offset));
        } else if (period === 'Month') {
            currentDate.setMonth(currentDate.getMonth() + offset);
        } else if (period === 'Year') {
            currentDate.setFullYear(currentDate.getFullYear() + offset);
        }

        // flatpickr will automatically update the visible input, but we need to set the hidden one
        const fp = document.querySelector("#SelectedDate")._flatpickr;
        fp.setDate(currentDate, true); // Set date and trigger change event
    }
</script>