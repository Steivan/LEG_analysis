@model PV.Forecasting.App.Models.VisualizationViewModel
@{
    ViewData["Title"] = "Time Series Visualization";
}

<h2>@ViewData["Title"]</h2>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<form asp-controller="Visualization" asp-action="Index" method="get" id="visualizationForm">
    <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 15px;">
        <div>
            <span>Period:</span>
            <select asp-for="SelectedPeriod" asp-items="Model.PeriodOptions"></select>
        </div>
        <div>
            <span>Date:</span>
            <button type="button" id="prevPeriod" onclick="changeDate(-1)">&lt;</button>
            <input type="text" id="SelectedDate" name="SelectedDate" value="@Model.SelectedDate.ToString("yyyy-MM-dd")" />
            <button type="button" id="nextPeriod" onclick="changeDate(1)">&gt;</button>
        </div>
        <div>
            <span>Resolution:</span>
            <select asp-for="SelectedView" asp-items="Model.ViewOptions"></select>
        </div>
    </div>

    <div style="display: flex; flex-direction: column;">
        @if (Model.PlotHtmls.Any())
        {
            var plotIndex = 0;
            foreach (var plot in Model.PlotHtmls)
            {
                var groupName = plot.Key;
                var (htmlWithLegend, htmlWithoutLegend) = plot.Value;
                var seriesLabels = Model.TimeSeriesLabelsByGroup[groupName];

                <div style="position: relative; margin-bottom: 10px; border: 1px solid #ccc; padding: 10px; border-radius: 5px;">

                    @* Container for controls *@
                    <div style="position: absolute; top: 10px; right: 10px; z-index: 10; background-color: rgba(255,255,255,0.8); padding: 5px; border-radius: 5px; display: flex; flex-direction: column; gap: 5px;">

                        @* Legend Toggle *@
                        <div>
                            <input type="checkbox" id="legendToggle-@plotIndex" checked onchange="toggleLegend(@plotIndex)">
                            <label for="legendToggle-@plotIndex">Show Legend</label>
                        </div>

                        @* Per-plot Time Series Toggles *@
                        <div style="border-top: 1px solid #ccc; padding-top: 5px;">
                            @foreach (var seriesName in seriesLabels)
                            {
                                var displayName = System.Text.RegularExpressions.Regex.Replace(seriesName, "(\\B[A-Z])", " $1");
                                <div>
                                    <input type="checkbox" name="SelectedTimeSeries" value="@seriesName" @(Model.SelectedTimeSeries.Contains(seriesName) ? "checked" : "") />
                                    <label>@displayName</label>
                                </div>
                            }
                        </div>
                    </div>

                    @* Render both plot versions *@
                    <div id="@($"plot-{plotIndex}-with-legend")">@Html.Raw(htmlWithLegend)</div>
                    <div id="@($"plot-{plotIndex}-without-legend")" style="display: none;">@Html.Raw(htmlWithoutLegend)</div>
                </div>
                plotIndex++;
            }
        }
        @* Add a single update button at the end *@
        <div style="margin-top: 20px;">
            <input type="submit" value="Update Plots" class="btn btn-primary" />
        </div>
        
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        flatpickr("#SelectedDate", {
            altInput: true,
            altFormat: "d.m.y",
            dateFormat: "Y-m-d",
            defaultDate: "@Model.SelectedDate.ToString("yyyy-MM-dd")",
            onChange: function(selectedDates, dateStr, instance) {
                // The actual input value is already updated by flatpickr
                document.getElementById('visualizationForm').submit();
            }
        });

        ['SelectedPeriod', 'SelectedView'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.addEventListener('change', () => {
                    document.getElementById('visualizationForm').submit();
                });
            }
        });
    });

    function changeDate(offset) {
        const dateInput = document.getElementById('SelectedDate');
        const period = document.getElementById('SelectedPeriod').value;
        let currentDate = new Date(dateInput.value);

        if (period === 'Day') {
            currentDate.setDate(currentDate.getDate() + offset);
        } else if (period === 'Week') {
            currentDate.setDate(currentDate.getDate() + (7 * offset));
        } else if (period === 'Month') {
            currentDate.setMonth(currentDate.getMonth() + offset);
        } else if (period === 'Year') {
            currentDate.setFullYear(currentDate.getFullYear() + offset);
        }

        // flatpickr will automatically update the visible input, but we need to set the hidden one
        const fp = document.querySelector("#SelectedDate")._flatpickr;
        fp.setDate(currentDate, true); // Set date and trigger change event
    }

    function toggleLegend(plotIndex) {
        const checkbox = document.getElementById(`legendToggle-${plotIndex}`);
        const plotWithLegend = document.getElementById(`plot-${plotIndex}-with-legend`);
        const plotWithoutLegend = document.getElementById(`plot-${plotIndex}-without-legend`);

        if (checkbox.checked) {
            plotWithLegend.style.display = 'block';
            plotWithoutLegend.style.display = 'none';
        } else {
            plotWithLegend.style.display = 'none';
            plotWithoutLegend.style.display = 'block';
        }
    }
</script>